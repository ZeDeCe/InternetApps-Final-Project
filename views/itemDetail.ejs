<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('./partials/head', {title: item.name + " - Details"}); %>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <%- include('./partials/header'); %>
    <div class="content-wrapper">
        <div class="container main-div">
            <div class="item-detail-card">
                <img src="<%= item.picture %>" alt="<%= item.name %>" class="item-detail-image">
                <div class="item-detail-content">
                    <h1 class="item-name"><%= item.name %></h1>
                    <p class="item-price">$<%= item.price.toFixed(2) %></p>
                    <p class="item-theme">Theme: <%= item.theme %></p>
                    <p class="item-pieces">Pieces: <%= item.pieces %></p>
                    <p><%= item.description %></p>
                    <div id="averageRating" class="rating">
                        <% 
                        const avgRating = item.ratings.length 
                            ? item.ratings.reduce((sum, rating) => sum + rating.value, 0) / item.ratings.length 
                            : 0;
                        const roundedAvgRating = Math.round(avgRating * 2) / 2;
                        %>
                        <% for (let i = 1; i <= 5; i++) { %>
                            <span class="star <%= i <= roundedAvgRating ? 'filled' : '' %>">★</span>
                        <% } %>
                        <span>(<%= avgRating.toFixed(1) %> avg, <%= item.ratings.length %> ratings)</span>
                    </div>
                    <button id="addToCartBtn" class="view-details">Add to Cart</button>
                </div>
            </div>

            <div id="notification"></div>

            <% if (user) { %>
                <div class="item-card">
                    <form id="ratingForm">
                        <h3>Rate this Item</h3>
                        <div class="star-rating">
                            <% for (let i = 1; i <= 5; i++) { %>
                                <input type="radio" id="ratingStar<%= i %>" name="rating" value="<%= i %>" <%= (userRating && userRating.value === i) ? 'checked' : '' %>>
                                <label for="ratingStar<%= i %>">★</label>
                            <% } %>
                        </div>
                        <button type="submit" class="view-details">Submit Rating</button>
                    </form>
                </div>

                <div class="item-card">
                    <form id="commentForm">
                        <h3>Add a Comment</h3>
                        <textarea id="comment" name="comment" rows="4" required></textarea>
                        <button type="submit" class="view-details">Submit Comment</button>
                    </form>
                </div>
            <% } else { %>
                <p class="alert alert-info">Please <a href="/login">log in</a> to rate or comment on this item.</p>
            <% } %>

            <div id="commentsSection" class="item-card">
                <h2>Comments</h2>
                <% if (item.comments && item.comments.length > 0) { %>
                    <% item.comments.forEach(comment => { %>
                        <div class="comment" data-username="<%= comment.username %>" data-comment-id="<%= comment._id %>">
                            <div class="comment-rating">
                                <% const userRating = item.ratings.find(rating => rating.username === comment.username); %>
                                <% if (userRating) { %>
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <span class="star <%= i <= userRating.value ? 'filled' : '' %>">★</span>
                                    <% } %>
                                <% } %>
                            </div>
                            <p><%= comment.text %></p>
                            <p class="comment-info">Posted by <%= comment.username %> on <%= new Date(comment.createdAt).toLocaleDateString() %></p>
                            <% if (isAdmin) { %>
                                <button class="delete-comment-btn view-details">Delete Comment</button>
                            <% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p>No comments yet.</p>
                <% } %>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        function showNotification(message) {
            $('#notification').text(message).fadeIn().delay(3000).fadeOut();
        }

        function updateAverageRating(newRating) {
            const avgRating = parseFloat(newRating);
            const roundedAvgRating = Math.round(avgRating * 2) / 2;
            
            $('#averageRating .star').each(function(index) {
                $(this).toggleClass('filled', index < roundedAvgRating);
            });
            
            $('#averageRating span').text(`(${avgRating.toFixed(1)} avg, <%= item.ratings.length + 1 %> ratings)`);
        }

        function updateUserComments(username, newRating) {
            $(`.comment[data-username="${username}"] .star`).each(function(index) {
                $(this).toggleClass('filled', index < newRating);
            });
        }

        function addCommentToDisplay(comment) {
            const commentHtml = `
                <div class="comment" data-username="${comment.username}" data-comment-id="${comment._id}">
                    <div class="comment-rating">
                        ${Array(5).fill().map((_, i) => `
                            <span class="star ${i < comment.rating ? 'filled' : ''}">★</span>
                        `).join('')}
                    </div>
                    <p>${comment.text}</p>
                    <p class="comment-info">Posted by ${comment.username} on ${new Date().toLocaleDateString()}</p>
                    ${<%= isAdmin %> ? `
                        <button class="delete-comment-btn view-details">Delete Comment</button>
                    ` : ''}
                </div>
            `;
            $('#commentsSection').prepend(commentHtml);
        }

        // Rating form submission
        $('#ratingForm').on('submit', function(e) {
            e.preventDefault();
            const rating = $('input[name="rating"]:checked').val();
            $.ajax({
                url: '/items/<%= item._id %>/rate',
                method: 'POST',
                data: { rating: rating },
                success: function(response) {
                    showNotification('Rating submitted successfully!');
                    updateAverageRating(response.avgRating);
                    updateUserComments('<%= user %>', rating);
                },
                error: function(xhr, status, error) {
                    showNotification('Error submitting rating. Please try again.');
                }
            });
        });

        // Comment form submission
        $('#commentForm').on('submit', function(e) {
            e.preventDefault();
            const comment = $('#comment').val();
            $.ajax({
                url: '/items/<%= item._id %>/comment',
                method: 'POST',
                data: { comment: comment },
                success: function(response) {
                    showNotification('Comment submitted successfully!');
                    addCommentToDisplay({
                        _id: response.comment._id,
                        text: comment,
                        username: '<%= user %>',
                        rating: $('#ratingForm input[name="rating"]:checked').val() || 0
                    });
                    $('#comment').val(''); // Clear the comment field
                },
                error: function(xhr, status, error) {
                    showNotification('Error submitting comment. Please try again.');
                }
            });
        });

        // Delete comment button click handler
        $(document).on('click', '.delete-comment-btn', function() {
            const commentId = $(this).closest('.comment').data('comment-id');
            if (confirm('Are you sure you want to delete this comment?')) {
                $.ajax({
                    url: `/items/<%= item._id %>/comment/${commentId}`,
                    method: 'DELETE',
                    success: function(response) {
                        showNotification('Comment deleted successfully!');
                        $(`.comment[data-comment-id="${commentId}"]`).remove();
                    },
                    error: function(xhr, status, error) {
                        showNotification('Error deleting comment. Please try again.');
                    }
                });
            }
        });

        // Add to Cart button logic
        $('#addToCartBtn').on('click', function() {
            $.ajax({
                url: '/cart/add/<%= item._id %>',
                method: 'GET',
                success: function(response) {
                    showNotification('Item added to cart successfully!');
                },
                error: function(xhr, status, error) {
                    showNotification('Error adding item to cart. Please try again.');
                }
            });
        });
    });
    </script>
    <%- include('./partials/footer'); %>
</body>
</html>