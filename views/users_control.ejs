<!DOCTYPE html>
<html>
    <head>
        <%- include('./partials/head', {title: "Website: Admin Page"}); %>
    </head>
    <body>
        <%- include('./partials/header'); %>
        <div class="container mt-4 main-div">
            <h1 class="mb-4">Admin Dashboard</h1>

            <!-- User Management Section -->
            <div class="mb-4">
                <h2>Manage Users</h2>
                <div class="mt-2">
                    <button class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        Create New User
                    </button>
                    <button class="btn btn-primary mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFilter" aria-expanded="false" aria-controls="collapseFilter">
                        Filter
                    </button>
                </div>
                <div class="collapse mt-1" id="collapseFilter">
                    <div class="input-group mb-3">
                        <span class="input-group-text">@</span>
                        <input type="text" class="form-control" id="userSearch" placeholder="Search Users...">
                    </div>
                    <div class="row justify-content-start mb-3">
                        <div class="col-2">
                            <div class="input-group">
                                <span class="input-group-text">Is Admin</span>
                                <div class="input-group-text">
                                    <input id="isadminSearch" class="form-check-input mt-0" type="checkbox" value="">
                                </div>
                            </div>
                        </div>
                        <div class="col" data-provide="datepicker">
                            <div class="input-group">
                                <span class="input-group-text">Created Between</span>
                                <input type="date" class="form-control" id="dateStartSearch">
                                <input type="date" class="form-control" id="dateEndSearch">
                            </div>
                        </div>
                    </div>
                </div>
                
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Is Admin</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <% users.forEach(user => { %>
                            <tr>
                                <td><%= user._id %></td>
                                <td><%= user.name %></td>
                                <td><%= user.isAdmin %></td>
                                <td id="actions">
                                    <button class="btn btn-warning btn-sm editUser" data-id="<%= user._id %>">Edit</button>
                                    <button class="btn btn-danger btn-sm deleteUser" data-id="<%= user._id %>">Delete</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <!-- Create User Modal -->
            <div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="createUserForm">
                                <div class="mb-3">
                                    <label for="userName" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="userName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="userFullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="userFullName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="userPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="userPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="isAdmin" class="form-check-label">Is Admin</label>
                                    <input type="checkbox" class="form-check-input" id="isAdmin" checked="true">
                                </div>
                                <button type="submit" class="btn btn-primary">Create User</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit User Modal -->
            <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <div class="mb-3">
                                    <label for="editUserName" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="editUserName" disabled>
                                </div>
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="editName">
                                </div>
                                <div class="mb-3">
                                    <label for="editUserPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="editUserPassword">
                                </div>
                                <div class="mb-3">
                                    <label for="editIsAdmin" class="form-check-label">Is Admin</label>
                                    <input type="checkbox" class="form-check-input" id="editIsAdmin" checked="true">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete User Confirmation Modal -->
            <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this user?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteUser">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            
            $(document).ready(function() {
                $('#isadminSearch').prop("indeterminate", true)

                // Handle search
                $('#userSearch').on('input', filterTable)

                $('#isadminSearch').click(filterTable)
                $('#dateStartSearch').on('input', filterTable)
                $('#dateEndSearch').on('input', filterTable)

                function filterTable() {
                    const searchName = $('#userSearch').val().toLowerCase()
                    const isAdmin = $('#isadminSearch').is(":checked");
                    const startDate = new Date($('#dateStartSearch').val())
                    const endDate = new Date($('#dateEndSearch').val())

                    $('#userTableBody tr').each(function(){
                        const myName = $(this).find('td:eq(0)').text().toLowerCase() + $(this).find('td:eq(1)').text().toLowerCase();
                        const myIsAdmin = $(this).find('td:eq(2)').text() === 'true'
                        const rowDate = new Date($(this).find('td:eq(3)').text());

                        if ((searchName === '' || myName.includes(searchName))
                            && ($('#isadminSearch').is(':indeterminate') || isAdmin === myIsAdmin)
                            && ($('#dateStartSearch').val() === '' ||  startDate <= rowDate)
                            && ($('#dateEndSearch').val() === '' ||  endDate >= rowDate)) {
                                $(this).show()
                        }
                        else {
                            $(this).hide()
                        }
                    })
                }

                // Handle delete user button click
                $(document).on('click', '.deleteUser', function() {
                    const userId = $(this).data('id');
                    $('#confirmDeleteUser').data('id', userId);
                    $('#deleteUserModal').modal('show');
                });

                // Confirm delete user
                $('#confirmDeleteUser').click(function() {
                    const userId = $(this).data('id');
                    $.post('/user/delete', {username: userId}).done(function(data) {
                        if(data) {
                            // Display error
                            console.log(data)
                        }
                        else {
                            $('#userTableBody').find(`.deleteUser[data-id="${userId}"]`).closest('tr').remove();
                            $('#deleteUserModal').modal('hide');
                        }
                    })
                });

                // Handle create user form submission
                $('#createUserForm').submit(function(event) {
                    event.preventDefault();
                    const newUser = {
                        _id: $('#userName').val(),
                        name: $('#userFullName').val(),
                        password: $("#userPassword").val(),
                        isAdmin: ($("#isAdmin:checked").val() === "on")
                    };
                    $.post('/user/create', {user: newUser}).done(function(data) {
                        if(data) {
                            $('#userTableBody').append(`
                                <tr>
                                    <td>${newUser._id}</td>
                                    <td>${newUser.name}</td>
                                    <td>${newUser.isAdmin}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm editUser" data-id="${newUser._id}">Edit</button>
                                        <button class="btn btn-danger btn-sm deleteUser" data-id="${newUser._id}">Delete</button>
                                    </td>
                                </tr>
                            `);
                            $('#createUserModal').modal('hide');
                            $('#createUserForm')[0].reset();
                        } else {
                            // Display error
                            console.log("BAD!")
                        }
                    })
                    
                });

                // Handle edit user button click
                $(document).on('click', '.editUser', function() {
                    const userId = $(this).data('id');
                    $.get('/user/' + userId).done(function(user) {
                        if (typeof(user)==="object") {
                            user = user[0]
                            $('#editUserName').val(user._id);
                            $('#editName').val(user.name);
                            if(!user.isAdmin) {
                                $('#editIsAdmin').removeAttr("checked");
                            } else {
                                $('#editIsAdmin').attr("checked", true);
                            }
                            $('#editUserModal').modal('show');
                        } else {
                            console.log("Cannot find a user in DB")
                        }
                    })
                    
                });
                // Handle edit user form submission
                $('#editUserForm').submit(function(event) {
                    event.preventDefault()
                    const userId = $('#editUserName').val()
                    var userdata = {
                        name: $('#editName').val(),
                        isAdmin: $('#editIsAdmin').attr("checked") !== undefined
                    }
                    if ($('#editPassword').val() !== undefined) {
                        userdata.password = $('#editPassword').val()
                    }
                    console.log(userId, userdata)
                    $.post('/user/update', {username: userId, data: userdata}).done(function(data) {
                        if(data) {
                            console.log(data)
                            return
                        }
                        const row = $('#userTableBody').find(`.editUser[data-id="${userId}"]`).closest('tr');
                        row.find('td:eq(1)').text(userdata.name);
                        row.find('td:eq(2)').text(userdata.isAdmin);
                        $('#editUserModal').modal('hide');
                    })
                    
                });

            });
        </script>
        <%- include('./partials/footer'); %>
    </body>
</html>