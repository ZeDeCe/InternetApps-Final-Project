<!DOCTYPE html>
<html>
    <head>
        <%- include('./partials/head', {title: "TONNS: Personal Page"}); %>
    </head>
    <body class="bg-light">
        <%- include('./partials/header'); %>
        <div class="main-div">
            <%- include('./partials/backbutton'); %>
            <div class="w-100 mt-4">
                <div class="g-0 row justify-content-center">
                    <!--User page main tab-->
                    <div class="col-8 mb-2 p-0">
                        <div class="mx-2 p-3 bg-white shadow rounded">
                            <div class="row g-2 w-75 align-items-center">
                                <div class="col-3">
                                    <b>Viewing orders placed in</b>
                                </div>
                                <div class="col-3">
                                    <select class="form-select" aria-label="Default select example" id="dateSearch">
                                        <option value="all" selected>All time</option>
                                        <option value="7d">Last 7 days</option>
                                        <option value="30d">Last 30 days</option>
                                        <option value="3m">Last 3 months</option>
                                    </select> <!--TODO: add select button to filter orders by time. for ADMIN add filter by user-->
                                </div>
                                <% if(isAdmin) {%>
                                <div class="col-4">
                                    <div class="input-group flex-nowrap">
                                        <span class="input-group-text" id="addon-wrapping">@</span>
                                        <input id="userSearch" type="text" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="addon-wrapping">
                                      </div>
                                </div>
                                <%}%>
                            </div>
                            <%- include('./partials/ordertable', {userorders: userorders}) %>
                        </div>
                    </div>
                    <!--Re-purchase tab-->
                    <% if(!isAdmin) {%>
                        <%- include('./partials/randomitems', {items_rebuy}) %>
                    <%}%>
                </div>
            </div>
            <!--Delete modal-->
            <% if(isAdmin) {%>
                <%-include('./partials/confirm', {message: "Are you sure you want to delete this order?", title: "Delete Order"})%>
            <%}%>
        </div>
        
        <!--Logout button-->
        <script>
            $(document).ready(function(){
                $('#dateSearch').on('change', filterRows)

                <%if(isAdmin) {%>
                $('#userSearch').on('input', filterRows)

                // Handle delete order button click
                $(document).on('click', '.deleteOrder', function() {
                    const orderid = $(this).data('id');
                    $('#confirmDelete').data('id', orderid);
                    $('#deleteModal').modal('show');
                });

                // Confirm delete order
                $('#confirmDelete').click(function() {
                    const orderid = $(this).data('id');
                    $.post('/order/delete', {orderid}).done(function(data) {
                        if(data) {
                            location.href = "/error"
                        }
                        else {
                            var ordertodelete = $(`#singleorder[data-id="${orderid}"]`)
                            var closestuser = ordertodelete.closest("#userdiv[user]")
                            if(!ordertodelete || !closestuser) {
                                location.href = "/error"
                                return
                            }
                            if(closestuser.children("#singleorder").length <= 1) {
                                closestuser.remove()
                            } else {
                                ordertodelete.remove();
                            }
                            $('#deleteModal').modal('hide');
                        }
                    })
                });
                <%}%>
                function filterRows() {
                    var option = $('#dateSearch').val();
                    var today = new Date();
                    var startDate;
                    switch (option) {
                        case "3m":
                            startDate = new Date(today.getTime() - 3 * 30 * 24 * 60 * 60 * 1000);
                            break;
                        case "7d":
                            startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case "30d":
                            startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                            break;
                        default:
                            startDate = new Date(0);
                            break;
                    }
                    
                    $("[id^=\"userdiv\"]").each(function() {
                        var show = false
                        $(this).children("[id^=\"singleorder\"]").each(function() {
                            var date = new Date($(this).find('#actualDate').text());
                            if(date >= startDate) {
                                show = true
                                $(this).show()
                            } else {
                                $(this).hide()
                            }
                        })
                        <%if(isAdmin) {%>
                        var user = $(this).attr('user')
                        var userSearch = $('#userSearch').val()
                        <%}%>
                        if(show 
                            <%if(isAdmin) {%>
                            && (userSearch === '' || user.includes(userSearch))
                            <%}%>
                        ) {
                            $(this).show()
                        } else {
                            $(this).hide()
                        }
                    })
                }
            })
        </script>
        <%- include('./partials/footer'); %>
    </body>
</html>